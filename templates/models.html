<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linear Regression Models</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e9 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        h1 {
            color: #1976d2;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        nav {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        .nav-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #1976d2;
            color: #1976d2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .nav-btn:hover, .nav-btn.active {
            background: #1976d2;
            color: white;
        }
        .model-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .model-card h2 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .metric-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e9 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #1976d2;
        }
        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976d2;
        }
        .coefficients {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .coefficients h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .coeff-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #43a047;
        }
        .coeff-name {
            font-weight: bold;
            color: #555;
        }
        .coeff-value {
            font-family: 'Courier New', monospace;
            color: #1976d2;
            font-weight: bold;
        }
        .equation {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #1976d2;
        }
        .equation h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        .equation-text {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #333;
            line-height: 1.8;
            overflow-x: auto;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #1976d2;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .info-box h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        .info-box p {
            color: #856404;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåä Water Quality Analysis</h1>
            <p class="subtitle">Linear Regression Models for Each Organism</p>
            <nav>
                <a href="/" class="nav-btn">Predict</a>
                <a href="/correlations" class="nav-btn">Correlations</a>
                <a href="/models" class="nav-btn active">Models</a>
            </nav>
        </header>

        <div class="info-box">
            <h3>üìò Understanding Linear Regression Models</h3>
            <p>
                Each organism has its own trained linear regression model that predicts abundance based on 4 water quality parameters.
                The <strong>R¬≤ score</strong> measures how well the model fits the data (0-1, higher is better).
                The <strong>RMSE</strong> shows the average prediction error (lower is better).
                <strong>Coefficients</strong> indicate how each parameter influences the prediction.
            </p>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading linear regression models...</p>
        </div>

        <div id="modelsContainer"></div>
    </div>

    <script>
        async function loadModels() {
            try {
                const response = await fetch('/api/linear-regression-demo');
                const data = await response.json();
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';

                const container = document.getElementById('modelsContainer');
                const models = data.models;

                let html = '';
                for (const [organism, modelInfo] of Object.entries(models)) {
                    const r2Percent = (modelInfo.r2_score * 100).toFixed(1);
                    const r2Color = modelInfo.r2_score > 0.7 ? '#43a047' : modelInfo.r2_score > 0.4 ? '#ffa726' : '#e53935';
                    
                    html += `
                        <div class="model-card">
                            <h2>
                                <span style="font-size: 1.2em;">ü¶†</span>
                                ${organism}
                            </h2>
                            
                            <div class="metrics-grid">
                                <div class="metric-box">
                                    <div class="metric-label">R¬≤ Score</div>
                                    <div class="metric-value" style="color: ${r2Color};">${modelInfo.r2_score.toFixed(4)}</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Accuracy</div>
                                    <div class="metric-value" style="color: ${r2Color};">${r2Percent}%</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">RMSE</div>
                                    <div class="metric-value">${modelInfo.rmse.toFixed(4)}</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Intercept</div>
                                    <div class="metric-value">${modelInfo.intercept.toFixed(4)}</div>
                                </div>
                            </div>

                            <div class="coefficients">
                                <h3>üìä Model Coefficients</h3>
                    `;

                    for (const [param, value] of Object.entries(modelInfo.coefficients)) {
                        html += `
                            <div class="coeff-item">
                                <span class="coeff-name">${param}</span>
                                <span class="coeff-value">${value.toFixed(6)}</span>
                            </div>
                        `;
                    }

                    html += `
                            </div>

                            <div class="coefficients">
                                <h3>üîó Correlations with Water Parameters</h3>
                    `;

                    for (const [param, value] of Object.entries(modelInfo.correlations)) {
                        const corrColor = value > 0 ? '#43a047' : '#e53935';
                        html += `
                            <div class="coeff-item">
                                <span class="coeff-name">${param}</span>
                                <span class="coeff-value" style="color: ${corrColor};">${value.toFixed(4)}</span>
                            </div>
                        `;
                    }

                    html += `
                            </div>

                            <div class="equation">
                                <h3>üìê Regression Equation</h3>
                                <div class="equation-text">
                                    Abundance = ${modelInfo.intercept.toFixed(4)}
                    `;

                    for (const [param, value] of Object.entries(modelInfo.coefficients)) {
                        const sign = value >= 0 ? '+' : '';
                        html += ` ${sign} (${value.toFixed(6)} √ó ${param})`;
                    }

                    html += `
                                </div>
                            </div>

                            <div style="margin-top: 20px; background: white; padding: 20px; border-radius: 10px;">
                                <h3 style="color: #1976d2; margin-bottom: 15px;">üìà Actual vs Predicted Values</h3>
                                <canvas id="chart_${organism.replace(/\s+/g, '_')}" width="800" height="400"></canvas>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

                // Draw charts for each organism
                for (const [organism, modelInfo] of Object.entries(models)) {
                    drawRegressionChart(organism, modelInfo.plot_data, modelInfo.r2_score);
                }

            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    `<p style="color: red;">Error loading models: ${error.message}</p>`;
            }
        }

        function drawRegressionChart(organism, plotData, r2Score) {
            const canvasId = `chart_${organism.replace(/\s+/g, '_')}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            // Setup margins
            const margin = { top: 40, right: 40, bottom: 60, left: 70 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Get data ranges
            const allValues = plotData.flatMap(d => [d.actual, d.predicted]);
            const minVal = Math.min(...allValues);
            const maxVal = Math.max(...allValues);
            const range = maxVal - minVal;
            const yMin = Math.max(0, minVal - range * 0.1);
            const yMax = maxVal + range * 0.1;
            
            // Scaling functions
            const xScale = (idx) => margin.left + (idx / (plotData.length - 1)) * chartWidth;
            const yScale = (val) => margin.top + chartHeight - ((val - yMin) / (yMax - yMin)) * chartHeight;
            
            // Draw title
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${organism} - Actual vs Predicted (R¬≤ = ${r2Score.toFixed(3)})`, width / 2, 25);
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + chartHeight);
            ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
            ctx.stroke();
            
            // Draw grid lines and y-axis labels
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#666';
            ctx.font = '11px Arial';
            ctx.textAlign = 'right';
            
            const yTicks = 5;
            for (let i = 0; i <= yTicks; i++) {
                const val = yMin + (yMax - yMin) * (i / yTicks);
                const y = yScale(val);
                
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + chartWidth, y);
                ctx.stroke();
                
                ctx.fillText(val.toFixed(2), margin.left - 10, y + 4);
            }
            
            // Y-axis label
            ctx.save();
            ctx.translate(20, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.font = 'bold 13px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#333';
            ctx.fillText('Abundance', 0, 0);
            ctx.restore();
            
            // X-axis labels (site IDs)
            ctx.fillStyle = '#666';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';
            plotData.forEach((d, idx) => {
                const x = xScale(idx);
                ctx.fillText(`Site ${d.site_id}`, x, margin.top + chartHeight + 20);
            });
            
            // X-axis label
            ctx.font = 'bold 13px Arial';
            ctx.fillStyle = '#333';
            ctx.fillText('Sample Sites', width / 2, height - 10);
            
            // Draw lines
            // Actual values (blue line)
            ctx.strokeStyle = '#1976d2';
            ctx.lineWidth = 3;
            ctx.beginPath();
            plotData.forEach((d, idx) => {
                const x = xScale(idx);
                const y = yScale(d.actual);
                if (idx === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Predicted values (red line)
            ctx.strokeStyle = '#e53935';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            plotData.forEach((d, idx) => {
                const x = xScale(idx);
                const y = yScale(d.predicted);
                if (idx === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw points
            plotData.forEach((d, idx) => {
                const x = xScale(idx);
                
                // Actual (blue circle)
                ctx.fillStyle = '#1976d2';
                ctx.strokeStyle = '#0d47a1';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, yScale(d.actual), 6, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                
                // Predicted (red square)
                const predY = yScale(d.predicted);
                ctx.fillStyle = '#e53935';
                ctx.strokeStyle = '#b71c1c';
                ctx.fillRect(x - 5, predY - 5, 10, 10);
                ctx.strokeRect(x - 5, predY - 5, 10, 10);
            });
            
            // Draw legend
            const legendX = margin.left + 20;
            const legendY = margin.top + 20;
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(legendX - 10, legendY - 10, 120, 60);
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.strokeRect(legendX - 10, legendY - 10, 120, 60);
            
            // Actual
            ctx.fillStyle = '#1976d2';
            ctx.beginPath();
            ctx.arc(legendX + 5, legendY + 5, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#1976d2';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(legendX - 5, legendY + 5);
            ctx.lineTo(legendX + 15, legendY + 5);
            ctx.stroke();
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Actual', legendX + 20, legendY + 10);
            
            // Predicted
            ctx.fillStyle = '#e53935';
            ctx.fillRect(legendX, legendY + 25, 10, 10);
            ctx.strokeStyle = '#e53935';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(legendX - 5, legendY + 30);
            ctx.lineTo(legendX + 15, legendY + 30);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#333';
            ctx.fillText('Predicted', legendX + 20, legendY + 35);
        }

        // Load models on page load
        loadModels();
    </script>
</body>
</html>
